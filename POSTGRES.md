
## Работа СУБД в составе dcape и использование ее для разворачиваемых приложений

СУБД запускается в контейнере с именем `$PROJECT_NAME_db_1`.

### Резервирование и восстановление баз данных

Проектом [dcape-app-pg-backup](https://github.com/dopos/dcape-app-pg-backup) для БД
реализованы автоматические механизмы резервирования баз данных путем создания дампов
в каталоге `./var/data/db-backup`, где `./` - это каталог установки dcape.
Каталог для хранения дампов указывается при старте контейнера Postgres
в переменной `DCAPE_DB_DUMP_DEST`.

### Обновление версии Postgres

Обновление Postgres выполняется двумя способами:

* облегченный, без применения специальных инструментов - остановка контейнера,
переключение в конфиге `.env` настройки на новый образ и запуск контейнера - выполняется при
обновлении корректирующих (minor) версий Postgres;
* основной, с применением специального сценария pg_upgrade_wpipe из Makefile - при обновлении основных (major) версий Postgres.

#### Обновление основной версии при помощи pg_upgrade.

Описание процедуры обновления. 
1. подготовка и запуск контейнера с новой версией Postgres
2. выполнение миграции баз данных в новый Postgres при помощи конвеера `pg_dump_all -h <using_db> -p <db port> | psql` 
3. остановка обоих контейнеров Postgres
4. переконфигурация каталога data: 
- резервирование текущего каталога; 
- перемещение нового каталога на место текущего; 
- перенос конфигурационных файлов со старой версии в новую

Эта процедура выполняется сценарием `pg_upgrade_wpipe` в `Makefile` проекта `dcape`. После выполнения сценария, данные из каталога `data`
предыдущей версии кластера Postgres будут сохранены в каталоге `{DCAPE_DIR}/var/data/db_<номер предыдущей версии>`. В случае необходимости отменить обновление, можно запустить предыдущую версию кластера БД с этим каталогом. 

Со стороны пользователя, для обновления Postgres по этому алгоритму необходимо выполнить:
* установить значение с новой версией для PG_IMAGE в .env
* выполнить команду `make pg_upgrade_wpipe`
* если обновление произошло успешно, запустить Postgres командой `make dc CMD="up -d db"`  

#### Работа с резервными копиями кластера Postgres.

В случае необходимости создания полного дампа кластера Postgres (резервирование, перенос на другой сервер),
дамп можно создать командой:

```
 make pg_dumpall
```
Сценарий создает файл дампа с именем: `pg_dumpall_$${PROJECT_NAME}_`date +"%d.%m.%Y"`.sql.gz"` (по умолчанию PROJECT_NAME=dcape)

Для загрузки дампа кластера Postgres использовать:

```
 make pg_load_dumpall
```
Сценарий загружает файл дампа кластера с именем, созданным `make pg_dumpall`.
